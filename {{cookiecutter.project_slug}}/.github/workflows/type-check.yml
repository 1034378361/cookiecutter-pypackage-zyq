name: æ·±åº¦ç±»å‹æ£€æŸ¥

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€è¿è¡Œ
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Pythonç‰ˆæœ¬'
        required: false
        default: '3.12'
        type: string
      full-report:
        description: 'ç”Ÿæˆå®Œæ•´æŠ¥å‘Š'
        required: false
        default: true
        type: boolean

env:
  PYTHON_DEFAULT: "3.12"
  SOURCE_DIR: src
  MIN_COVERAGE: 70  # æœ€ä½ç±»å‹è¦†ç›–ç‡ç›®æ ‡

jobs:
  deep-type-check:
    name: æ·±åº¦ç±»å‹æ£€æŸ¥ä¸æŠ¥å‘Š
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ github.event.inputs.python-version || env.PYTHON_DEFAULT }}
        cache: pip

    # ç¼“å­˜PDM
    - name: ç¼“å­˜PDMå’Œä¾èµ–
      uses: actions/cache@v4.0.2
      with:
        path: |
          ~/.pdm
          .pdm-build
          .venv
        key: ${{ runner.os }}-pdm-typecheck-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pdm-typecheck-

    # ç¼“å­˜mypy
    - name: ç¼“å­˜mypy
      uses: actions/cache@v4.0.2
      with:
        path: |
          .mypy_cache
          ~/.cache/mypy
        key: ${{ runner.os }}-mypy-deep-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-mypy-deep-

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pdm

        # ä»…å®‰è£…ç±»å‹æ£€æŸ¥æ‰€éœ€ä¾èµ–
        if pdm group list | grep -q typing; then
          echo "ä½¿ç”¨typingä¾èµ–ç»„"
          pdm install -G typing
        else
          echo "ä½¿ç”¨devä¾èµ–ç»„"
          pdm install -G dev
        fi

        # å®‰è£…é¢å¤–çš„ç±»å‹æ£€æŸ¥å·¥å…·
        pip install mypy-baseline types-all

    - name: æ£€æŸ¥ä¸Šæ¬¡ç±»å‹è¦†ç›–ç‡
      id: last_coverage
      continue-on-error: true
      run: |
        # å°è¯•ä»ä¹‹å‰çš„æ„å»ºä¸­è·å–ä¸Šæ¬¡çš„ç±»å‹è¦†ç›–ç‡
        if [ -f ".mypy-baseline.txt" ]; then
          LAST_COVERAGE=$(grep -oP "Statement coverage: \K[0-9.]+" .mypy-baseline.txt || echo "0")
          echo "value=${LAST_COVERAGE}" >> $GITHUB_OUTPUT
          echo "å·²æ‰¾åˆ°ä¸Šæ¬¡è¦†ç›–ç‡: ${LAST_COVERAGE}%"
        else
          echo "value=0" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°ä¸Šæ¬¡è¦†ç›–ç‡è®°å½•"
        fi

    - name: è¿è¡Œå®Œæ•´ç±»å‹æ£€æŸ¥
      id: type_check
      run: |
        mkdir -p mypy-report

        echo "æ‰§è¡Œæ·±åº¦ç±»å‹æ£€æŸ¥..."
        mypy --config-file pyproject.toml \
          --show-error-codes \
          --pretty \
          --warn-redundant-casts \
          --warn-unused-ignores \
          --warn-unreachable \
          --html-report mypy-report \
          --txt-report mypy-report \
          $SOURCE_DIR/ || echo "type_check_failed=true" >> $GITHUB_OUTPUT

        echo "ç”Ÿæˆç±»å‹è¦†ç›–ç‡æŠ¥å‘Š..."
        echo "ç±»å‹è¦†ç›–ç‡æŠ¥å‘Š:" > mypy-report/coverage.txt
        mypy --config-file pyproject.toml \
          --no-error-summary \
          --no-pretty \
          --txt-report mypy-report/details \
          $SOURCE_DIR/ || true

        # æå–è¦†ç›–ç‡æ•°æ®
        COVERAGE_LINE=$(grep "Statement coverage:" mypy-report/details/index.txt || echo "Statement coverage: 0.0%")
        echo "$COVERAGE_LINE" >> mypy-report/coverage.txt

        # æå–æ•°å­—éƒ¨åˆ†ç”¨äºæ¯”è¾ƒ
        COVERAGE=$(echo "$COVERAGE_LINE" | grep -oP "Statement coverage: \K[0-9.]+" || echo "0")
        echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT

        # ä¿å­˜åŸºå‡†æ•°æ®ä¾›æœªæ¥æ¯”è¾ƒ
        echo "$COVERAGE_LINE" > .mypy-baseline.txt

        echo "# ç±»å‹æ£€æŸ¥æŠ¥å‘Š" > mypy-report/summary.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> mypy-report/summary.md
        echo "" >> mypy-report/summary.md
        echo "## ç±»å‹è¦†ç›–ç‡" >> mypy-report/summary.md
        echo '```' >> mypy-report/summary.md
        cat mypy-report/coverage.txt >> mypy-report/summary.md
        echo '```' >> mypy-report/summary.md

        # æ·»åŠ ä¸ä¸Šæ¬¡çš„å¯¹æ¯”
        if [ -n "${{ steps.last_coverage.outputs.value }}" ] && [ "${{ steps.last_coverage.outputs.value }}" != "0" ]; then
          DIFF=$(echo "$COVERAGE - ${{ steps.last_coverage.outputs.value }}" | bc)
          echo "" >> mypy-report/summary.md
          echo "## ä¸ä¸Šæ¬¡æ¯”è¾ƒ" >> mypy-report/summary.md
          echo "ä¸Šæ¬¡è¦†ç›–ç‡: ${{ steps.last_coverage.outputs.value }}%" >> mypy-report/summary.md

          if (( $(echo "$DIFF > 0" | bc -l) )); then
            echo "å˜åŒ–: +${DIFF}% ğŸš€" >> mypy-report/summary.md
          elif (( $(echo "$DIFF < 0" | bc -l) )); then
            echo "å˜åŒ–: ${DIFF}% ğŸ“‰" >> mypy-report/summary.md
          else
            echo "å˜åŒ–: æ— å˜åŒ– â–" >> mypy-report/summary.md
          fi
        fi

        # æ·»åŠ é”™è¯¯æ€»ç»“
        ERROR_COUNT=$(grep -c "error:" mypy-report/details/index.txt || echo "0")
        echo "" >> mypy-report/summary.md
        echo "## é”™è¯¯ç»Ÿè®¡" >> mypy-report/summary.md
        echo "æ€»é”™è¯¯æ•°: ${ERROR_COUNT}" >> mypy-report/summary.md

        if [ "$ERROR_COUNT" -gt 0 ] && [ "${{ github.event.inputs.full-report }}" == "true" ]; then
          echo "" >> mypy-report/summary.md
          echo "## å¸¸è§é”™è¯¯ç±»å‹" >> mypy-report/summary.md
          echo '```' >> mypy-report/summary.md
          grep "error:" mypy-report/details/index.txt | sed 's/.*error: //' | sort | uniq -c | sort -nr | head -10 >> mypy-report/summary.md
          echo '```' >> mypy-report/summary.md
        fi

    - name: ä¸Šä¼ ç±»å‹æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4.6.2
      with:
        name: mypy-report
        path: mypy-report/
        retention-days: 30

    - name: åˆ†æç±»å‹è¦†ç›–ç‡
      if: always()
      run: |
        echo "## ç±»å‹æ£€æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.type_check.outputs.type_check_failed }}" == "true" ]; then
          echo "âš ï¸ **ç±»å‹æ£€æŸ¥å‘ç°é”™è¯¯**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **ç±»å‹æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        fi

        COVERAGE="${{ steps.type_check.outputs.coverage }}"
        echo "ğŸ“Š **ç±»å‹è¦†ç›–ç‡**: ${COVERAGE}% (ç›®æ ‡: ${MIN_COVERAGE}%)" >> $GITHUB_STEP_SUMMARY

        # ä¸ä¸Šæ¬¡è¦†ç›–ç‡æ¯”è¾ƒ
        if [ -n "${{ steps.last_coverage.outputs.value }}" ] && [ "${{ steps.last_coverage.outputs.value }}" != "0" ]; then
          DIFF=$(echo "$COVERAGE - ${{ steps.last_coverage.outputs.value }}" | bc)

          if (( $(echo "$DIFF > 0" | bc -l) )); then
            echo "ğŸ“ˆ **æ”¹è¿›**: +${DIFF}% (ç›¸æ¯”ä¸Šæ¬¡)" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$DIFF < 0" | bc -l) )); then
            echo "ğŸ“‰ **ä¸‹é™**: ${DIFF}% (ç›¸æ¯”ä¸Šæ¬¡)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â– **æ— å˜åŒ–**: è¦†ç›–ç‡ä¿æŒä¸å˜" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # ç›®æ ‡è¯„ä¼°
        if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
          echo "âŒ **æœªè¾¾æ ‡**: ç±»å‹è¦†ç›–ç‡ä½äºç›®æ ‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **å·²è¾¾æ ‡**: ç±»å‹è¦†ç›–ç‡è¾¾åˆ°æˆ–è¶…è¿‡ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
        fi

        echo "ğŸ“„ **å®Œæ•´æŠ¥å‘Š**: å¯åœ¨æ„å»ºäº§ç‰©ä¸­ä¸‹è½½" >> $GITHUB_STEP_SUMMARY

    # å¯é€‰ï¼šå‘é€ç±»å‹æ£€æŸ¥æŠ¥å‘Šé€šçŸ¥
    # - name: å‘é€é€šçŸ¥
    #   if: always()
    #   uses: rtCamp/action-slack-notify@v2
    #   env:
    #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    #     SLACK_TITLE: "ç±»å‹æ£€æŸ¥æŠ¥å‘Š"
    #     SLACK_MESSAGE: "ç±»å‹è¦†ç›–ç‡: ${{ steps.type_check.outputs.coverage }}%"
    #     SLACK_COLOR: ${{ job.status }}
