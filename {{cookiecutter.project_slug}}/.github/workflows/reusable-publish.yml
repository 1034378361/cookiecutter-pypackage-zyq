name: å¯å¤ç”¨å‘å¸ƒæµç¨‹

on:
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0)'
        required: true
        type: string
      release-notes:
        description: 'å‘å¸ƒè¯´æ˜Ž'
        required: false
        type: string
      python-version:
        description: 'Pythonç‰ˆæœ¬'
        required: false
        type: string
        default: '3.12'
    outputs:
      pypi-url:
        description: 'PyPI URL'
        value: ${{ jobs.publish.outputs.pypi_url }}
      github-release-url:
        description: 'GitHub Release URL'
        value: ${{ jobs.publish.outputs.github_release_url }}

env:
  PYTHON_MIN: '3.10'

jobs:
  publish:
    name: æž„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      pypi_url: ${{ steps.get_urls.outputs.pypi_url }}
      github_release_url: ${{ steps.get_urls.outputs.github_release_url }}

    steps:
    - uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ env.PYTHON_MIN }} # ä½¿ç”¨æ”¯æŒçš„æœ€ä½ŽPythonç‰ˆæœ¬æž„å»º
        cache: pip

    - name: å®‰è£…æž„å»ºä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pdm twine build wheel

    - name: æž„å»ºåŒ…
      id: build
      env:
        VERSION: ${{ inputs.version }}
      run: |
        pdm build
        echo "wheel_file=$(ls dist/*.whl)" >> $GITHUB_OUTPUT
        echo "sdist_file=$(ls dist/*.tar.gz)" >> $GITHUB_OUTPUT
        echo "files_count=$(ls dist/ | wc -l)" >> $GITHUB_OUTPUT

    - name: éªŒè¯æž„å»ºäº§ç‰©
      run: |
        # æ£€æŸ¥æž„å»ºæ–‡ä»¶æ•°é‡
        if [ "${{ steps.build.outputs.files_count }}" -lt 2 ]; then
          echo "::error::æž„å»ºå¯èƒ½ä¸å®Œæ•´ï¼Œé¢„æœŸè‡³å°‘æœ‰wheelå’Œsdistä¸¤ä¸ªæ–‡ä»¶"
          exit 1
        fi

        # éªŒè¯wheelåŒ…
        if [ ! -f "${{ steps.build.outputs.wheel_file }}" ]; then
          echo "::error::æ‰¾ä¸åˆ°wheelåŒ…æ–‡ä»¶"
          exit 1
        fi

        # éªŒè¯æºç åŒ…
        if [ ! -f "${{ steps.build.outputs.sdist_file }}" ]; then
          echo "::error::æ‰¾ä¸åˆ°æºç åŒ…æ–‡ä»¶"
          exit 1
        fi

        # ä½¿ç”¨twineæ£€æŸ¥åŒ…
        python -m twine check dist/*

        echo "æž„å»ºéªŒè¯é€šè¿‡ âœ…"

    - name: å‘å¸ƒåˆ°PyPI
      id: pypi_publish
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: false
        verbose: true

    - name: å‡†å¤‡å‘å¸ƒè¯´æ˜Ž
      id: prepare_notes
      run: |
        if [ -n "${{ inputs.release-notes }}" ]; then
          echo "${{ inputs.release-notes }}" > RELEASE_NOTES.md
        else
          echo "Release v${{ inputs.version }}" > RELEASE_NOTES.md
        fi

    - name: åˆ›å»ºGitHub Release
      id: github_release
      uses: softprops/action-gh-release@v2.2.2
      with:
        tag_name: v${{ inputs.version }}
        name: Release v${{ inputs.version }}
        body_path: RELEASE_NOTES.md
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: èŽ·å–å‘å¸ƒURL
      id: get_urls
      run: |
        PACKAGE_NAME=$(python -c "import json; print(json.load(open('pyproject.toml'))['project']['name'])")
        PYPI_URL="https://pypi.org/project/${PACKAGE_NAME}/${{ inputs.version }}/"
        GITHUB_RELEASE_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/v${{ inputs.version }}"

        echo "pypi_url=${PYPI_URL}" >> $GITHUB_OUTPUT
        echo "github_release_url=${GITHUB_RELEASE_URL}" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒæ‘˜è¦
      run: |
        echo "## ðŸš€ å‘å¸ƒæˆåŠŸ v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ **PyPI**: [${PACKAGE_NAME} v${{ inputs.version }}](https://pypi.org/project/${PACKAGE_NAME}/${{ inputs.version }}/)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **GitHub Release**: [v${{ inputs.version }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/v${{ inputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **æ–‡ä»¶**:" >> $GITHUB_STEP_SUMMARY
        echo "  - Wheel: $(basename ${{ steps.build.outputs.wheel_file }})" >> $GITHUB_STEP_SUMMARY
        echo "  - Source: $(basename ${{ steps.build.outputs.sdist_file }})" >> $GITHUB_STEP_SUMMARY
