name: 测试

on:
  push:
    branches-ignore: [main, master]  # 非主分支代码推送时测试
  pull_request:
    types: [opened, synchronize]  # PR创建和更新时触发
    branches-ignore: [main, master]  # 非主分支PR时测试
  workflow_dispatch:
    inputs:
      python-version:
        description: '指定Python版本测试'
        required: false
        type: string

# 权限配置
permissions:
  contents: read  # 只读权限即可
  checks: write   # 允许上传测试结果
  pull-requests: write  # 允许评论PR

env:
  SOURCE_DIR: src
  TEST_DIR: tests
  PYTHON_DEFAULT: "3.12"
  MIN_PYTHON: "3.10"
  COVERAGE_THRESHOLD: 85

jobs:
  # 使用可复用工作流进行测试
  test:
    name: 测试 Python ${{ inputs.python-version || '3.12' }}
    uses: ./.github/workflows/reusable-test.yml
    with:
      python-version: ${{ inputs.python-version || '3.12' }}
      coverage-threshold: 85

  # 使用可复用工作流进行代码质量检查
  quality:
    name: 代码质量检查
    needs: test
    uses: ./.github/workflows/reusable-quality.yml
    with:
      python-version: '3.12'

  # 使用可复用工作流进行类型检查
  type-check:
    name: 类型检查
    needs: test
    uses: ./.github/workflows/reusable-type-check.yml
    with:
      python-version: '3.12'
