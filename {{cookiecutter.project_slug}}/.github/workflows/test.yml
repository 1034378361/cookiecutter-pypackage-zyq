name: æµ‹è¯•

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      python-version:
        description: 'æŒ‡å®šPythonç‰ˆæœ¬æµ‹è¯•'
        required: false
        type: string

env:
  SOURCE_DIR: src
  TEST_DIR: tests
  PYTHON_DEFAULT: "3.12"
  MIN_PYTHON: "3.8"
  COVERAGE_THRESHOLD: 85

jobs:
  # æµ‹è¯•çŸ©é˜µ - åœ¨ä¸åŒPythonç‰ˆæœ¬ä¸Šè¿è¡Œæµ‹è¯•
  test:
    name: æµ‹è¯• Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        # å¦‚æžœé€šè¿‡æ‰‹åŠ¨è§¦å‘å¹¶æŒ‡å®šäº†Pythonç‰ˆæœ¬ï¼Œåˆ™ä»…æµ‹è¯•è¯¥ç‰ˆæœ¬
        include:
          - python-version: ${{ github.event.inputs.python-version }}
            if: ${{ github.event.inputs.python-version != '' }}

    steps:
    - uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    # ç¼“å­˜PDMå’Œä¾èµ–
    - name: ç¼“å­˜PDM
      uses: actions/cache@v4.0.2
      with:
        path: |
          ~/.pdm
          .pdm-build
          .venv
        key: ${{ runner.os }}-pdm-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pdm-${{ matrix.python-version }}-

    # ç¼“å­˜pytest
    - name: ç¼“å­˜pytest
      uses: actions/cache@v4.0.2
      with:
        path: |
          .pytest_cache
          ~/.cache/pytest
        key: ${{ runner.os }}-pytest-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pytest-${{ matrix.python-version }}-

    - name: å®‰è£… PDM
      run: |
        python -m pip install --upgrade pip
        pip install pdm

    - name: ä½¿ç”¨ PDM å®‰è£…ä¾èµ–
      run: |
        # ä»…å®‰è£…æµ‹è¯•æ‰€éœ€ä¾èµ–
        if pdm group list | grep -q test; then
          echo "ä½¿ç”¨testä¾èµ–ç»„"
          pdm install -G test
        else
          echo "ä½¿ç”¨devä¾èµ–ç»„"
          pdm install -G dev
        fi

    - name: è¿è¡Œæµ‹è¯•
      id: test_run
      run: |
        pdm run pytest \
          --cov=$SOURCE_DIR \
          --cov-report=term \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=$COVERAGE_THRESHOLD \
          --junitxml=junit/test-results-${{ matrix.python-version }}.xml \
          $TEST_DIR/ || echo "tests_failed=true" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
      uses: codecov/codecov-action@v4.5.0
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage.xml
        fail_ci_if_error: false

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4.3.1
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit/test-results-${{ matrix.python-version }}.xml
          htmlcov/
        retention-days: 7

    - name: æµ‹è¯•æ‘˜è¦
      if: always()
      run: |
        echo "## Python ${{ matrix.python-version }} æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.test_run.outputs.tests_failed }}" == "true" ]; then
          echo "âŒ **æµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šäº†è§£å¤±è´¥åŽŸå› " >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **æµ‹è¯•é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        fi

        # æå–è¦†ç›–çŽ‡æ•°æ®
        if [ -f coverage.xml ]; then
          COVERAGE=$(grep -o 'line-rate="[0-9].[0-9]*"' coverage.xml | head -1 | grep -o '[0-9].[0-9]*')
          COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc)
          echo "ðŸ“Š **è¦†ç›–çŽ‡**: ${COVERAGE_PCT}% (é˜ˆå€¼: ${COVERAGE_THRESHOLD}%)" >> $GITHUB_STEP_SUMMARY
        fi

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ env.PYTHON_DEFAULT }}
        cache: pip

    # ç¼“å­˜PDM
    - name: ç¼“å­˜PDMå’Œä¾èµ–
      uses: actions/cache@v4.0.2
      with:
        path: |
          ~/.pdm
          .pdm-build
          .venv
        key: ${{ runner.os }}-pdm-quality-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pdm-quality-

    # ç¼“å­˜Ruff
    - name: ç¼“å­˜Ruff
      uses: actions/cache@v4.0.2
      with:
        path: |
          ~/.cache/ruff
        key: ${{ runner.os }}-ruff-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-ruff-

    - name: å®‰è£… PDM
      run: |
        python -m pip install --upgrade pip
        pip install pdm

    - name: ä½¿ç”¨ PDM å®‰è£…ä¾èµ–
      run: |
        # ä»…å®‰è£…lintæ‰€éœ€ä¾èµ–
        if pdm group list | grep -q lint; then
          echo "ä½¿ç”¨lintä¾èµ–ç»„"
          pdm install -G lint
        else
          echo "ä½¿ç”¨devä¾èµ–ç»„"
          pdm install -G dev
        fi

    - name: è¿è¡Œ Ruff ä»£ç æ£€æŸ¥
      id: ruff_check
      run: |
        pdm run ruff check . || echo "ruff_failed=true" >> $GITHUB_OUTPUT

    - name: è¿è¡Œ Ruff æ ¼å¼æ£€æŸ¥
      id: ruff_format
      run: |
        pdm run ruff format --check . || echo "format_failed=true" >> $GITHUB_OUTPUT

    - name: è¿è¡Œå®‰å…¨æ£€æŸ¥ (Bandit)
      id: security_check
      run: |
        if pdm list | grep -q bandit; then
          echo "è¿è¡ŒBanditå®‰å…¨æ£€æŸ¥"
          pdm run bandit -r $SOURCE_DIR -x tests -c pyproject.toml || echo "security_failed=true" >> $GITHUB_OUTPUT
        else
          echo "é¡¹ç›®æœªé…ç½®Banditï¼Œè·³è¿‡å®‰å…¨æ£€æŸ¥"
        fi

    - name: ä»£ç è´¨é‡æ‘˜è¦
      if: always()
      run: |
        echo "## ä»£ç è´¨é‡æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.ruff_check.outputs.ruff_failed }}" == "true" ]; then
          echo "âŒ **Ruff ä»£ç æ£€æŸ¥å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Ruff ä»£ç æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.ruff_format.outputs.format_failed }}" == "true" ]; then
          echo "âŒ **ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.security_check.outputs.security_failed }}" == "true" ]; then
          echo "âš ï¸ **å®‰å…¨æ£€æŸ¥å‘çŽ°é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.security_check.outputs.security_failed }}" == "" ]; then
          echo "âœ… **å®‰å…¨æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **æœªè¿è¡Œå®‰å…¨æ£€æŸ¥**" >> $GITHUB_STEP_SUMMARY
        fi

  # ç±»åž‹æ£€æŸ¥
  type-check:
    name: ç±»åž‹æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ env.PYTHON_DEFAULT }}
        cache: pip

    # ç¼“å­˜PDM
    - name: ç¼“å­˜PDMå’Œä¾èµ–
      uses: actions/cache@v4.0.2
      with:
        path: |
          ~/.pdm
          .pdm-build
          .venv
        key: ${{ runner.os }}-pdm-mypy-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pdm-mypy-

    # ç¼“å­˜mypy
    - name: ç¼“å­˜mypy
      uses: actions/cache@v4.0.2
      with:
        path: |
          .mypy_cache
          ~/.cache/mypy
        key: ${{ runner.os }}-mypy-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-mypy-

    - name: å®‰è£… PDM
      run: |
        python -m pip install --upgrade pip
        pip install pdm

    - name: ä½¿ç”¨ PDM å®‰è£…ä¾èµ–
      run: |
        # ä»…å®‰è£…ç±»åž‹æ£€æŸ¥æ‰€éœ€ä¾èµ–
        if pdm group list | grep -q typing; then
          echo "ä½¿ç”¨typingä¾èµ–ç»„"
          pdm install -G typing
        else
          echo "ä½¿ç”¨devä¾èµ–ç»„"
          pdm install -G dev
        fi

    - name: ç±»åž‹æ£€æŸ¥ï¼ˆMypyï¼‰
      id: mypy_check
      run: |
        pdm run mypy --config-file pyproject.toml \
          --show-error-codes \
          --pretty \
          --warn-redundant-casts \
          --warn-unused-ignores \
          --warn-unreachable \
          --html-report mypy_report \
          $SOURCE_DIR/ || echo "mypy_failed=true" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ ç±»åž‹æ£€æŸ¥æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4.3.1
      with:
        name: mypy-report
        path: mypy_report/
        retention-days: 7

    - name: ç±»åž‹æ£€æŸ¥æ‘˜è¦
      if: always()
      run: |
        echo "## ç±»åž‹æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.mypy_check.outputs.mypy_failed }}" == "true" ]; then
          echo "âŒ **ç±»åž‹æ£€æŸ¥å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šäº†è§£é—®é¢˜" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **ç±»åž‹æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        fi
