name: éƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
      - 'src/**/*.py'  # æ·»åŠ æºä»£ç æ–‡ä»¶ï¼Œå› ä¸ºå¯èƒ½åŒ…å«æ–‡æ¡£å­—ç¬¦ä¸²
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'github-pages'
        type: choice
        options:
          - github-pages
          - production

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: æž„å»ºå’Œéƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: pip

      # ç¼“å­˜MkDocsæž„å»º
      - name: ç¼“å­˜MkDocs
        uses: actions/cache@v4
        with:
          path: |
            .cache
            site/.cache
          key: ${{ runner.os }}-mkdocs-${{ hashFiles('mkdocs.yml') }}-${{ hashFiles('docs/**') }}
          restore-keys: |
            ${{ runner.os }}-mkdocs-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pdm
          # å¦‚æžœPDMæœ‰æ–‡æ¡£ç»„ï¼Œåªå®‰è£…æ–‡æ¡£ç›¸å…³ä¾èµ–
          if pdm group list | grep -q docs; then
            echo "ä½¿ç”¨docsä¾èµ–ç»„"
            pdm install -G docs
          else
            echo "ä½¿ç”¨devä¾èµ–ç»„"
            pdm install -G dev
          fi

      - name: æž„å»ºæ–‡æ¡£
        id: build
        run: |
          pdm run mkdocs build --strict
          echo "doc_files=$(find site -type f | wc -l)" >> $GITHUB_OUTPUT

      - name: éªŒè¯æž„å»º
        run: |
          # æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶æ•°é‡
          if [ "${{ steps.build.outputs.doc_files }}" -lt 5 ]; then
            echo "::error::æ–‡æ¡£æž„å»ºå¯èƒ½ä¸å®Œæ•´ï¼Œç”Ÿæˆçš„æ–‡ä»¶æ•°é‡è¿‡å°‘"
            exit 1
          fi

          # æ£€æŸ¥ç´¢å¼•æ–‡ä»¶
          if [ ! -f "site/index.html" ]; then
            echo "::error::æœªæ‰¾åˆ°ä¸»é¡µæ–‡ä»¶ (index.html)"
            exit 1
          fi

          echo "æ–‡æ¡£æž„å»ºéªŒè¯é€šè¿‡"

      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          full_commit_message: "æ›´æ–°æ–‡æ¡£ - ${{ github.event.head_commit.message || 'æ‰‹åŠ¨è§¦å‘æ›´æ–°' }}"

      - name: ç”Ÿæˆéƒ¨ç½²URL
        id: deployment
        run: |
          REPO_OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          DOCS_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/"
          echo "url=${DOCS_URL}" >> $GITHUB_OUTPUT

          echo "::notice title=æ–‡æ¡£å·²éƒ¨ç½²::æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ° ${DOCS_URL}"

      - name: éƒ¨ç½²æ‘˜è¦
        run: |
          echo "## æ–‡æ¡£éƒ¨ç½²æˆåŠŸ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š **é¡¹ç›®æ–‡æ¡£**: [${{ steps.deployment.outputs.url }}](${{ steps.deployment.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **æ–‡ä»¶æ•°é‡**: ${{ steps.build.outputs.doc_files }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ **éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
