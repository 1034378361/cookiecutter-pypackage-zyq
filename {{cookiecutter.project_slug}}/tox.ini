[tox]
isolated_build = True
envlist = py38, py39, py310, py311, py312, lint, docs
parallel = true

[gh-actions]
python =
    3.8: py38
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312
    3.12: lint, docs

[testenv:lint]
deps =
    black>=25.1.0
    isort>=6.0.1
    ruff>=0.11.0
    mypy>=1.16.0
    bandit>=1.8.3
    types-PyYAML
    types-requests
    types-setuptools
    types-toml
    pre-commit>=3.6.0
commands =
    ruff check {toxinidir}/src {toxinidir}/tests
    ruff format --check {toxinidir}/src {toxinidir}/tests
    black --check {toxinidir}/src {toxinidir}/tests
    isort --check {toxinidir}/src {toxinidir}/tests
    mypy {toxinidir}/src
    # 检查调试语句
    bash -c "! grep -r 'import pdb' {toxinidir}/src {toxinidir}/tests"
    bash -c "! grep -r 'breakpoint()' {toxinidir}/src {toxinidir}/tests"
    # 检查合并冲突
    bash -c "! grep -r '<<<<<<< HEAD' {toxinidir}/src {toxinidir}/tests {toxinidir}/docs"

[testenv:docs]
deps =
    sphinx
    sphinx-rtd-theme
commands =
    sphinx-build -b html {toxinidir}/docs {toxinidir}/docs/_build/html

[testenv]
setenv =
    PYTHONPATH = {toxinidir}
passenv =
    HOME
    PYTHONPATH
deps =
    pytest
    pytest-cov
extras =
    dev
commands =
    pytest --cov=src --cov-report=term --cov-report=xml --cov-fail-under=85 {posargs:tests}
